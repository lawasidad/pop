<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>New Sale</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      padding: 20px;
      background: #eef;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 850px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button {
      padding: 8px;
      font-size: 1em;
      margin: 10px 0;
      box-sizing: border-box;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
    }
    .total-amount {
      font-weight: bold;
      font-size: 1.2em;
      background: #d4edda;
      padding: 8px 15px;
      border-radius: 8px;
      color: #155724;
      min-width: 170px;
      text-align: center;
    }
    .customer-section {
      margin-bottom: 15px;
    }
    .search-box {
      margin-bottom: 15px;
    }
    #productList {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
    }
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 10px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    .product-info {
      flex: 1 1 200px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .product-details {
      flex: 1 1 300px;
      font-size: 0.9em;
      color: #555;
    }
    .controls {
      flex: 1 1 320px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .controls input {
      width: 60px;
      text-align: center;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
    .controls label {
      font-size: 0.85em;
      margin-right: 4px;
    }
    .controls button {
      width: 30px;
      height: 30px;
      font-size: 1.2em;
      line-height: 1;
      padding: 0;
      cursor: pointer;
      background: #007bff;
      border: none;
      color: white;
      border-radius: 5px;
    }
    .controls button:disabled {
      background: #ccc;
      cursor: default;
    }
    #saleResult {
      margin-top: 15px;
      font-weight: bold;
      color: green;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div class="total-amount" id="totalAmount">Total: 0 IQD</div>
      <button onclick="submitSale()">Submit Sale</button>
    </div>

    <div class="customer-section">
      <label>Customer Name:</label><br/>
      <input type="text" id="customer" placeholder="Enter customer name" />
    </div>

    <div class="search-box">
      <label>Search Product:</label><br/>
      <input type="text" id="searchInput" placeholder="Type product name..." oninput="filterProducts()" />
    </div>

    <div id="productList"></div>

    <div id="saleResult"></div>
  </div>

  <script>
    const products = [
      { name: "Kalashin", unitPrice: 1000, discount: 0 },
      { name: "Shusha", unitPrice: 1500, discount: 5 },
      { name: "Electronic", unitPrice: 3000, discount: 10 },
      { name: "Mobile", unitPrice: 5000, discount: 7 },
      { name: "Computer", unitPrice: 7000, discount: 15 },
    ];

    // extend products with quantity, discountOverride, freeCase
    const items = products.map(p => ({
      ...p,
      quantity: 0,
      discountOverride: p.discount,
      freeCase: null // must enter
    }));

    function renderProducts(filter = "") {
      const list = document.getElementById("productList");
      const filterLC = filter.toLowerCase();
      list.innerHTML = "";
      items.forEach((item, index) => {
        if (item.name.toLowerCase().includes(filterLC)) {
          const priceAfterDiscount = item.unitPrice * (1 - (item.discountOverride || 0) / 100);
          const total = (priceAfterDiscount * item.quantity) + (item.freeCase ? parseFloat(item.freeCase) : 0);

          list.innerHTML += `
            <div class="product-item" data-index="${index}">
              <div class="product-info">${item.name}</div>
              <div class="product-details">
                Unit Price: <input type="number" value="${item.unitPrice}" readonly style="width:90px; text-align:center; background:#eee; border:none;" />
                | Default Discount: ${item.discount}%
              </div>
              <div class="controls">
                <label>Quantity:</label>
                <button onclick="changeQty(${index}, -1)">-</button>
                <input type="number" min="0" value="${item.quantity}" oninput="updateQty(${index}, this.value)" />
                <button onclick="changeQty(${index}, 1)">+</button>
                
                <label>Discount (%):</label>
                <input type="number" min="0" max="100" value="${item.discountOverride}" oninput="updateDiscount(${index}, this.value)" />
                
                <label>Free Case (IQD):</label>
                <input type="number" min="0" value="${item.freeCase === null ? '' : item.freeCase}" oninput="updateFreeCase(${index}, this.value)" required />
              </div>
              <div style="min-width:120px; text-align:center; font-weight:bold;">
                Total: ${total.toLocaleString()} IQD
              </div>
            </div>
          `;
        }
      });
      updateTotal();
    }

    function changeQty(index, delta) {
      items[index].quantity += delta;
      if (items[index].quantity < 0) items[index].quantity = 0;
      renderProducts(document.getElementById("searchInput").value);
    }
    function updateQty(index, val) {
      let v = parseInt(val);
      if (isNaN(v) || v < 0) v = 0;
      items[index].quantity = v;
      renderProducts(document.getElementById("searchInput").value);
    }
    function updateDiscount(index, val) {
      let v = parseFloat(val);
      if (isNaN(v) || v < 0) v = 0;
      if (v > 100) v = 100;
      items[index].discountOverride = v;
      renderProducts(document.getElementById("searchInput").value);
    }
    function updateFreeCase(index, val) {
      let v = val.trim() === "" ? null : parseFloat(val);
      if (v !== null && (isNaN(v) || v < 0)) v = 0;
      items[index].freeCase = v;
      renderProducts(document.getElementById("searchInput").value);
    }

    function filterProducts() {
      const val = document.getElementById("searchInput").value;
      renderProducts(val);
    }

    function updateTotal() {
      const total = items.reduce((sum, i) => {
        if (i.quantity > 0) {
          if (i.freeCase === null) return sum; // skip if freeCase not entered
          const priceAfterDiscount = i.unitPrice * (1 - (i.discountOverride || 0) / 100);
          return sum + (priceAfterDiscount * i.quantity) + i.freeCase;
        }
        return sum;
      }, 0);
      document.getElementById("totalAmount").textContent = `Total: ${total.toLocaleString()} IQD`;
    }

    function submitSale() {
      const customer = document.getElementById("customer").value.trim();
      if (!customer) {
        alert("Please enter the customer name.");
        return;
      }

      // Validate freeCase for items with quantity > 0
      for (const i of items) {
        if (i.quantity > 0 && (i.freeCase === null || i.freeCase === "")) {
          alert(`Please enter Free Case amount for product: ${i.name}`);
          return;
        }
      }

      // Prepare sale data
      const saleItems = items.filter(i => i.quantity > 0).map(i => {
        const priceAfterDiscount = i.unitPrice * (1 - (i.discountOverride || 0) / 100);
        return {
          name: i.name,
          quantity: i.quantity,
          unitPrice: i.unitPrice,
          discount: i.discountOverride,
          freeCase: i.freeCase,
          total: (priceAfterDiscount * i.quantity) + i.freeCase
        };
      });

      if (saleItems.length === 0) {
        alert("Please select at least one product with quantity greater than zero.");
        return;
      }

      const totalSale = saleItems.reduce((sum, i) => sum + i.total, 0);

      const saleData = {
        customer,
        items: saleItems,
        total: totalSale
      };

      // Save to localStorage for sales.html
      localStorage.setItem("lastSale", JSON.stringify(saleData));

      document.getElementById("saleResult").textContent = "Sale submitted successfully!";

      // Optionally clear form
      // clearForm();
    }

    function clearForm() {
      document.getElementById("customer").value = "";
      items.forEach(i => {
        i.quantity = 0;
        i.discountOverride = i.discount;
        i.freeCase = null;
      });
      renderProducts();
      updateTotal();
      document.getElementById("saleResult").textContent = "";
    }

    // Initial render
    renderProducts();
  </script>
</body>
</html>
