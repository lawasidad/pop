<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Sale</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #14532d;
      margin: 0; padding: 10px;
    }
    .container {
      background: white;
      padding: 20px 25px;
      border-radius: 12px;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    /* ... (styles unchanged) ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div class="summary total-qty" id="totalQty">Qty: 0</div>
      <div class="summary total-amount" id="totalAmount">Total: 0 IQD</div>
      <button class="submit-btn" onclick="submitSale()">Submit Sale</button>
    </div>

    <select id="customer">
      <option value="">-- Select Customer --</option>
    </select>

    <input type="text" id="searchBox" oninput="renderProducts()" placeholder="Search product..." autocomplete="off" />

    <div class="product-list" id="productList"></div>
  </div>

<script>
  // products and items unchanged
  const products = [
    { name: "Kalesheen", unitPrice: 1000, discount: 0, stock: 50 },
    { name: "Bottle", unitPrice: 1500, discount: 5, stock: 30 },
    { name: "Electronics", unitPrice: 3000, discount: 10, stock: 20 },
  ];
  const items = products.map(p => ({ ...p, quantity: 0 }));

  // Load customers from localStorage and populate dropdown
  function loadCustomers() {
    const select = document.getElementById("customer");
    const customers = JSON.parse(localStorage.getItem("customers") || "[]");

    select.innerHTML = `<option value="">-- Select Customer --</option>`;
    customers.forEach(customer => {
      const name = typeof customer === "object" ? customer.name : customer;
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  }

  // Parse lat,lng from string "lat,lng"
  function parseLatLng(str) {
    if (!str) return null;
    const parts = str.split(',');
    if (parts.length !== 2) return null;
    const lat = parseFloat(parts[0]);
    const lng = parseFloat(parts[1]);
    if (isNaN(lat) || isNaN(lng)) return null;
    return { lat, lng };
  }

  // Calculate distance in meters between two lat,lng points (Haversine)
  function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function deg2rad(deg) {
    return deg * (Math.PI/180);
  }

  // Render product list
  function renderProducts() {
    const list = document.getElementById("productList");
    const search = document.getElementById("searchBox").value.trim().toLowerCase();
    list.innerHTML = "";

    items.forEach((item, index) => {
      if (search && !item.name.toLowerCase().includes(search)) return;
      const total = item.quantity * item.unitPrice * (1 - item.discount / 100);
      list.innerHTML += `
        <div class="product-item">
          <div>
            <div class="product-name">${item.name}</div>
            <div class="details">
              Price: ${item.unitPrice.toLocaleString()} IQD | Discount: ${item.discount}%<br>
              Qty: 
              <button onclick="changeQty(${index}, -1)">-</button>
              <input 
                type="number" 
                min="0" 
                max="${item.stock}" 
                value="${item.quantity}" 
                onchange="changeQtyDirect(${index}, this.value)" 
                style="width: 60px; text-align: center; border-radius: 6px; border: 1px solid #bbb; margin: 0 6px;"
              />
              <button onclick="changeQty(${index}, 1)">+</button>
              | Total: ${total.toLocaleString()} IQD
            </div>
          </div>
        </div>
      `;
    });
    updateSummary();
  }

  function changeQty(index, delta) {
    items[index].quantity += delta;
    if (items[index].quantity < 0) items[index].quantity = 0;
    if (items[index].quantity > items[index].stock) items[index].quantity = items[index].stock;
    renderProducts();
  }

  function changeQtyDirect(index, value) {
    let val = parseInt(value);
    if (isNaN(val) || val < 0) val = 0;
    if (val > items[index].stock) val = items[index].stock;
    items[index].quantity = val;
    renderProducts();
  }

  function updateSummary() {
    const total = items.reduce((sum, i) => sum + i.unitPrice * i.quantity * (1 - i.discount / 100), 0);
    const qty = items.reduce((sum, i) => sum + i.quantity, 0);
    document.getElementById("totalAmount").textContent = `Total: ${total.toLocaleString()} IQD`;
    document.getElementById("totalQty").textContent = `Qty: ${qty}`;
  }

  // Submit sale with check-in verification
  function submitSale() {
    const customerName = document.getElementById("customer").value.trim();
    if (!customerName) {
      alert("Please select a customer.");
      return;
    }

    const customers = JSON.parse(localStorage.getItem("customers") || "[]");
    const customer = customers.find(c => (typeof c === 'object' ? c.name : c) === customerName);

    if (!customer) {
      alert("Selected customer data not found.");
      return;
    }
    if (!customer.location) {
      alert("This customer does not have a GPS location.");
      return;
    }

    // Request user's current location first
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }

    navigator.geolocation.getCurrentPosition(position => {
      const userLatLng = { lat: position.coords.latitude, lng: position.coords.longitude };
      const custLatLng = parseLatLng(customer.location);

      if (!custLatLng) {
        alert("Invalid customer GPS data.");
        return;
      }

      const distance = getDistanceFromLatLonInMeters(userLatLng.lat, userLatLng.lng, custLatLng.lat, custLatLng.lng);

      if (distance > 50) {
        alert(`You are too far from the customer to check in.\nDistance: ${Math.round(distance)} meters (Must be within 50 meters).`);
        return;
      }

      // Distance ok, proceed to submit sale
      const selectedItems = items.filter(i => i.quantity > 0).map(i => ({
        name: i.name,
        quantity: i.quantity,
        unitPrice: i.unitPrice,
        discount: i.discount,
        total: i.unitPrice * i.quantity * (1 - i.discount / 100)
      }));

      if (selectedItems.length === 0) {
        alert("No products selected.");
        return;
      }

      const total = selectedItems.reduce((sum, i) => sum + i.total, 0);
      const qty = selectedItems.reduce((sum, i) => sum + i.quantity, 0);

      const saleData = {
        customer: customerName,
        items: selectedItems,
        total,
        totalQty: qty,
        timestamp: new Date().toISOString()
      };

      let allSales = JSON.parse(localStorage.getItem("allSales")) || [];
      allSales.push(saleData);
      localStorage.setItem("allSales", JSON.stringify(allSales));

      // Reset form
      document.getElementById("customer").value = "";
      document.getElementById("searchBox").value = "";
      items.forEach(i => i.quantity = 0);
      renderProducts();

      alert("Sale submitted successfully!");
    }, error => {
      alert("Error getting your location: " + error.message);
    });
  }

  window.onload = function () {
    loadCustomers();
    renderProducts();
  };
</script>
</body>
</html>
