<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Form with PDF Export</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
      direction: rtl;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      padding: 30px 25px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .item {
      margin-bottom: 12px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .item input {
      width: 60px;
      margin-left: 10px;
    }
    #submitBtn, #pdfBtn {
      margin-top: 20px;
      padding: 14px;
      width: 100%;
      max-width: 300px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #submitBtn {
      background-color: #1976d2;
      color: white;
    }
    #pdfBtn {
      background-color: #4caf50;
      color: white;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>New Sales Form</h2>

  <label for="customer">Customer Name</label>
  <input type="text" id="customer" placeholder="Enter customer name" />

  <div id="itemsList"></div>

  <button id="submitBtn">Submit Sale</button>

  <label for="pdfCustomer">Select Customer to Generate PDF</label>
  <select id="pdfCustomer">
    <option value="">-- Choose Customer --</option>
  </select>

  <button id="pdfBtn">Export Selected Invoice to PDF</button>
</div>

<script>
  const products = [
    { id: 1, name: "Product A", price: 20 },
    { id: 2, name: "Product B", price: 35 },
    { id: 3, name: "Product C", price: 50 }
  ];

  let sales = []; // Store all submitted sales

  const itemsList = document.getElementById("itemsList");
  const submitBtn = document.getElementById("submitBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const customerInput = document.getElementById("customer");
  const pdfCustomerSelect = document.getElementById("pdfCustomer");

  let cart = products.map(p => ({ ...p, quantity: 0 }));

  function renderItems() {
    itemsList.innerHTML = "";
    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <label>${item.name} - IQD ${item.price}</label>
        <input type="number" min="0" value="${item.quantity}" onchange="setQuantity(${item.id}, this.value)" />
      `;
      itemsList.appendChild(div);
    });
  }

  function setQuantity(id, value) {
    const idx = cart.findIndex(p => p.id === id);
    cart[idx].quantity = Math.max(0, Number(value));
  }

  submitBtn.onclick = () => {
    const customer = customerInput.value.trim();
    if (!customer) return alert("Please enter customer name.");
    const selectedItems = cart.filter(i => i.quantity > 0);
    if (selectedItems.length === 0) return alert("Please select products.");

    const sale = {
      customer,
      items: selectedItems,
      total: selectedItems.reduce((sum, i) => sum + i.price * i.quantity, 0)
    };
    sales.push(sale);

    // Add customer to select if not already
    if (![...pdfCustomerSelect.options].some(o => o.value === customer)) {
      const option = document.createElement("option");
      option.value = customer;
      option.textContent = customer;
      pdfCustomerSelect.appendChild(option);
    }

    alert(`Sale submitted for ${customer}.\nTotal: IQD ${sale.total}`);

    cart = products.map(p => ({ ...p, quantity: 0 }));
    customerInput.value = "";
    renderItems();
  };

  pdfBtn.onclick = async () => {
    const selectedCustomer = pdfCustomerSelect.value;
    if (!selectedCustomer) return alert("Please select a customer for PDF.");

    const sale = sales.find(s => s.customer === selectedCustomer);
    if (!sale) return alert("No sale found for selected customer.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text(`Invoice for ${sale.customer}`, 10, 20);

    doc.setFontSize(12);
    let y = 30;
    sale.items.forEach(item => {
      doc.text(`- ${item.name} x${item.quantity} = IQD ${item.price * item.quantity}`, 10, y);
      y += 10;
    });

    doc.setFontSize(14);
    doc.text(`Total: IQD ${sale.total}`, 10, y + 10);

    doc.save(`${sale.customer}_invoice.pdf`);
  };

  renderItems();
  window.setQuantity = setQuantity;
</script>
</body>
</html>
