<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>New Sale</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      padding: 20px;
      background: #eef2f7;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px 30px 40px 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background: #2a9df4;
      color: white;
      padding: 12px 25px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.3em;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 999;
    }
    .header .total {
      background: #145ea8;
      padding: 6px 15px;
      border-radius: 8px;
      min-width: 150px;
      text-align: center;
    }
    .header button {
      background: #f49a1a;
      border: none;
      color: white;
      padding: 10px 22px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    .header button:hover {
      background: #e88200;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      margin-top: 15px;
      font-size: 1em;
      color: #333;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 1em;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      border-color: #2a9df4;
      outline: none;
    }
    #searchInput {
      margin-bottom: 20px;
      font-size: 1.1em;
      font-weight: 600;
    }
    #productList {
      max-height: 480px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1.5px solid #ddd;
      background: #fafafa;
      padding: 10px 15px;
    }
    .product-item {
      display: flex;
      gap: 15px;
      align-items: center;
      padding: 14px 10px;
      border-bottom: 1.2px solid #ddd;
      flex-wrap: wrap;
    }
    .product-img {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      background-color: #eee;
      flex-shrink: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 700;
      font-size: 1.4em;
      color: #777;
      user-select: none;
      text-transform: uppercase;
    }
    .product-info {
      flex: 1 1 140px;
      font-weight: 700;
      font-size: 1.05em;
      color: #222;
    }
    .product-details {
      flex: 1 1 180px;
      font-size: 0.9em;
      color: #555;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      flex: 1 1 320px;
      justify-content: flex-end;
      align-items: center;
    }
    .controls label {
      font-weight: 500;
      font-size: 0.9em;
      margin-right: 4px;
      white-space: nowrap;
    }
    .controls input[type="number"] {
      width: 70px;
      padding: 6px 8px;
      font-size: 1em;
      text-align: center;
      border-radius: 6px;
      border: 1.2px solid #aaa;
    }
    .controls button {
      width: 32px;
      height: 32px;
      font-size: 1.3em;
      line-height: 1;
      background: #2a9df4;
      color: white;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .controls button:hover:not(:disabled) {
      background: #1a75d1;
    }
    .controls button:disabled {
      background: #bbb;
      cursor: not-allowed;
    }
    .total-product {
      width: 140px;
      font-weight: 700;
      font-size: 1em;
      text-align: center;
      color: #145ea8;
    }
    #saleResult {
      margin-top: 25px;
      font-weight: 700;
      font-size: 1.2em;
      text-align: center;
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="total" id="totalAmount">Total: 0 IQD</div>
      <button id="submitBtn" onclick="submitSale()">Submit Sale</button>
    </div>

    <label for="customer">Customer Name:</label>
    <input type="text" id="customer" placeholder="Enter customer name" />

    <label for="searchInput">Search Product:</label>
    <input type="text" id="searchInput" placeholder="Type product name..." oninput="filterProducts()" />

    <div id="productList"></div>

    <div id="saleResult"></div>
  </div>

  <script>
    // Sample images as simple initials in circles; here simplified as text inside .product-img
    const products = [
      { name: "Kalashin", unitPrice: 1000, discount: 0, img: "K" },
      { name: "Shusha", unitPrice: 1500, discount: 5, img: "S" },
      { name: "Electronic", unitPrice: 3000, discount: 10, img: "E" },
      { name: "Mobile", unitPrice: 5000, discount: 7, img: "M" },
      { name: "Computer", unitPrice: 7000, discount: 15, img: "C" },
    ];

    const items = products.map(p => ({
      ...p,
      quantity: 0,
      discountOverride: p.discount,
      freeCase: null
    }));

    function renderProducts(filter = "") {
      const list = document.getElementById("productList");
      const filterLC = filter.toLowerCase();
      list.innerHTML = "";
      items.forEach((item, index) => {
        if (!item.name.toLowerCase().includes(filterLC)) return;

        const priceAfterDiscount = item.unitPrice * (1 - (item.discountOverride || 0) / 100);
        const total = item.quantity > 0 && item.freeCase !== null
          ? (priceAfterDiscount * item.quantity) + item.freeCase
          : 0;

        list.innerHTML += `
          <div class="product-item" data-index="${index}">
            <div class="product-img">${item.img}</div>
            <div class="product-info">${item.name}</div>
            <div class="product-details">
              <div>Unit Price: <input type="number" value="${item.unitPrice}" readonly /></div>
              <div>Default Discount: ${item.discount}%</div>
            </div>
            <div class="controls">
              <label>Qty:</label>
              <button onclick="changeQty(${index}, -1)">-</button>
              <input type="number" min="0" value="${item.quantity}" oninput="updateQty(${index}, this.value)" />
              <button onclick="changeQty(${index}, 1)">+</button>

              <label>Discount %:</label>
              <input type="number" min="0" max="100" value="${item.discountOverride}" oninput="updateDiscount(${index}, this.value)" />

              <label>Free Case (IQD):</label>
              <input type="number" min="0" value="${item.freeCase === null ? '' : item.freeCase}" oninput="updateFreeCase(${index}, this.value)" required />
            </div>
            <div class="total-product">${total.toLocaleString()} IQD</div>
          </div>
        `;
      });
      updateTotal();
    }

    function changeQty(index, delta) {
      items[index].quantity = Math.max(0, items[index].quantity + delta);
      renderProducts(document.getElementById("searchInput").value);
    }
    function updateQty(index, val) {
      let v = parseInt(val);
      if (isNaN(v) || v < 0) v = 0;
      items[index].quantity = v;
      renderProducts(document.getElementById("searchInput").value);
    }
    function updateDiscount(index, val) {
      let v = parseFloat(val);
      if (isNaN(v) || v < 0) v = 0;
      if (v > 100) v = 100;
      items[index].discountOverride = v;
      renderProducts(document.getElementById("searchInput").value);
    }
    function updateFreeCase(index, val) {
      let v = val.trim() === "" ? null : parseFloat(val);
      if (v !== null && (isNaN(v) || v < 0)) v = 0;
      items[index].freeCase = v;
      renderProducts(document.getElementById("searchInput").value);
    }

    function filterProducts() {
      const val = document.getElementById("searchInput").value;
      renderProducts(val);
    }

    // Fixed total at top - sums all products with quantity >0 and freeCase entered
    function updateTotal() {
      const total = items.reduce((sum, item) => {
        if (item.quantity > 0 && item.freeCase !== null) {
          const priceAfterDiscount = item.unitPrice * (1 - (item.discountOverride || 0) / 100);
          return sum + (priceAfterDiscount * item.quantity) + item.freeCase;
        }
        return sum;
      }, 0);
      document.getElementById("totalAmount").textContent = `Total: ${total.toLocaleString()} IQD`;
    }

    function submitSale() {
      const customer = document.getElementById("customer").value.trim();
      if (!customer) {
        alert("Please enter the customer name.");
        return;
      }

      // Validate freeCase required if quantity > 0
      for (const i of items) {
        if (i.quantity > 0 && (i.freeCase === null || i.freeCase === "")) {
          alert(`Please enter Free Case amount for product: ${i.name}`);
          return;
        }
      }

      // Prepare sale data
      const saleItems = items.filter(i => i.quantity > 0).map(i => {
        const priceAfterDiscount = i.unitPrice * (1 - (i.discountOverride || 0) / 100);
        return {
          name: i.name,
          quantity: i.quantity,
          unitPrice: i.unitPrice,
          discount: i.discountOverride,
          freeCase: i.freeCase,
          total: (priceAfterDiscount * i.quantity) + i.freeCase
        };
      });

      if (saleItems.length === 0) {
        alert("Please select at least one product with quantity greater than zero.");
        return;
      }

      const totalSale = saleItems.reduce((sum, i) => sum + i.total, 0);

      const saleData = {
        customer,
        items: saleItems,
        total: totalSale
      };

      // Save sale data to localStorage for sales.html
      localStorage.setItem("lastSale", JSON.stringify(saleData));

      document.getElementById("saleResult").textContent = "Sale submitted successfully!";
    }

    // Initial render
    renderProducts();
  </script>
</body>
</html>
