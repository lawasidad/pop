<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>New Sale</title>
  <style>
    /* ...[هەمان style کە هەیە، تاقی بکە سەریدا بوونی ئەو style ـانە بەجێهێڵراوە]... */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="total" id="totalAmount">Total: 0 IQD</div>
      <button id="submitBtn" onclick="submitSale()">Submit Sale</button>
    </div>

    <label for="customer">Customer Name:</label>
    <input type="text" id="customer" placeholder="Enter customer name" />

    <label for="searchInput">Search Product:</label>
    <input type="text" id="searchInput" placeholder="Type product name..." oninput="filterProducts()" />

    <div id="productList"></div>

    <div id="saleResult"></div>
  </div>

  <script>
    const products = [
      { name: "Kalashin", unitPrice: 1000, discount: 0, img: "K" },
      { name: "Shusha", unitPrice: 1500, discount: 5, img: "S" },
      { name: "Electronic", unitPrice: 3000, discount: 10, img: "E" },
      { name: "Mobile", unitPrice: 5000, discount: 7, img: "M" },
      { name: "Computer", unitPrice: 7000, discount: 15, img: "C" },
    ];

    const items = products.map(p => ({
      ...p,
      quantity: 0,
      discountOverride: p.discount
    }));

    function renderProducts(filter = "") {
      const list = document.getElementById("productList");
      const filterLC = filter.toLowerCase();
      list.innerHTML = "";
      items.forEach((item, index) => {
        if (!item.name.toLowerCase().includes(filterLC)) return;

        const priceAfterDiscount = item.unitPrice * (1 - (item.discountOverride || 0) / 100);
        const total = item.quantity > 0 ? (priceAfterDiscount * item.quantity) : 0;

        list.innerHTML += `
          <div class="product-item" data-index="${index}">
            <div class="product-img">${item.img}</div>
            <div class="product-info">${item.name}</div>
            <div class="product-details">
              <div>Unit Price: <input type="number" value="${item.unitPrice}" readonly /></div>
              <div>Default Discount: ${item.discount}%</div>
            </div>
            <div class="controls">
              <label>Qty:</label>
              <button onclick="changeQty(${index}, -1)">-</button>
              <input type="number" min="0" value="${item.quantity}" oninput="updateQty(${index}, this.value)" />
              <button onclick="changeQty(${index}, 1)">+</button>

              <label>Discount %:</label>
              <input type="number" min="0" max="100" value="${item.discountOverride}" oninput="updateDiscount(${index}, this.value)" />
            </div>
            <div class="total-product">${total.toLocaleString()} IQD</div>
          </div>
        `;
      });
      updateTotal();
    }

    function changeQty(index, delta) {
      items[index].quantity = Math.max(0, items[index].quantity + delta);
      renderProducts(document.getElementById("searchInput").value);
    }

    function updateQty(index, val) {
      let v = parseInt(val);
      if (isNaN(v) || v < 0) v = 0;
      items[index].quantity = v;
      renderProducts(document.getElementById("searchInput").value);
    }

    function updateDiscount(index, val) {
      let v = parseFloat(val);
      if (isNaN(v) || v < 0) v = 0;
      if (v > 100) v = 100;
      items[index].discountOverride = v;
      renderProducts(document.getElementById("searchInput").value);
    }

    function filterProducts() {
      const val = document.getElementById("searchInput").value;
      renderProducts(val);
    }

    function updateTotal() {
      const total = items.reduce((sum, item) => {
        if (item.quantity > 0) {
          const priceAfterDiscount = item.unitPrice * (1 - (item.discountOverride || 0) / 100);
          return sum + (priceAfterDiscount * item.quantity);
        }
        return sum;
      }, 0);
      document.getElementById("totalAmount").textContent = `Total: ${total.toLocaleString()} IQD`;
    }

    function submitSale() {
      const customer = document.getElementById("customer").value.trim();
      if (!customer) {
        alert("Please enter the customer name.");
        return;
      }

      const saleItems = items.filter(i => i.quantity > 0).map(i => {
        const priceAfterDiscount = i.unitPrice * (1 - (i.discountOverride || 0) / 100);
        return {
          name: i.name,
          quantity: i.quantity,
          unitPrice: i.unitPrice,
          discount: i.discountOverride,
          total: priceAfterDiscount * i.quantity
        };
      });

      if (saleItems.length === 0) {
        alert("Please select at least one product with quantity greater than zero.");
        return;
      }

      const totalSale = saleItems.reduce((sum, i) => sum + i.total, 0);

      const saleData = {
        customer,
        items: saleItems,
        total: totalSale
      };

      // Save sale data to localStorage
      localStorage.setItem("lastSale", JSON.stringify(saleData));

      document.getElementById("saleResult").textContent = "Sale submitted successfully!";

      // Redirect to sales.html
      setTimeout(() => {
        window.location.href = "sales.html";
      }, 1000);
    }

    renderProducts();
  </script>
</body>
</html>
