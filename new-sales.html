<!DOCTYPE html>
<html lang="ku">
<head>
  <meta charset="UTF-8" />
  <title>Sales Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .product {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .product h3 {
      margin: 0 0 5px;
    }
    .product input {
      width: 50px;
    }
    .btn {
      padding: 10px 15px;
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      margin: 5px 0;
    }
    #downloadPdfBtn {
      display: none;
      background: #27ae60;
    }
  </style>
</head>
<body>

  <h2>فرۆشتنی کاڵا</h2>

  <label>ناوی کڕیار:</label>
  <input type="text" id="customer" placeholder="ناو بنووسە" /><br><br>

  <div id="productList"></div>

  <button class="btn" id="submitSaleBtn">Submit Sale</button>
  <button class="btn" id="downloadPdfBtn">Download PDF</button>

  <script>
    const products = [
      { id: 1, name: "کەلوپەلی یەک", price: 1000 },
      { id: 2, name: "کەلوپەلی دوو", price: 1500 },
      { id: 3, name: "کەلوپەلی سێ", price: 2000 },
    ];

    const cart = products.map(p => ({ ...p, quantity: 0, discount: 0 }));
    let lastSaleData = null;

    const productList = document.getElementById("productList");

    cart.forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <h3>${item.name}</h3>
        <p>نرخی یەکە: ${item.price} د.ع</p>
        <label>بڕ:</label>
        <button onclick="changeQuantity(${index}, -1)">-</button>
        <input type="number" id="qty-${index}" value="0" readonly />
        <button onclick="changeQuantity(${index}, 1)">+</button>
        <br>
        <label>داشکاندن (%):</label>
        <input type="number" id="discount-${index}" value="0" min="0" max="100" onchange="updateDiscount(${index})" />
      `;
      productList.appendChild(div);
    });

    function changeQuantity(index, delta) {
      cart[index].quantity = Math.max(0, cart[index].quantity + delta);
      document.getElementById(`qty-${index}`).value = cart[index].quantity;
    }

    function updateDiscount(index) {
      const val = parseFloat(document.getElementById(`discount-${index}`).value);
      cart[index].discount = isNaN(val) ? 0 : Math.min(100, Math.max(0, val));
    }

    document.getElementById("submitSaleBtn").onclick = () => {
      const customer = document.getElementById("customer").value.trim();
      if (customer === "") {
        alert("تکایە ناوی کڕیار بنووسە");
        return;
      }

      const items = cart.filter(i => i.quantity > 0).map(i => {
        const total = i.quantity * i.price * (1 - i.discount / 100);
        return {
          productName: i.name,
          quantity: i.quantity,
          unitPrice: i.price,
          discountPercent: i.discount,
          total: Math.round(total)
        };
      });

      if (items.length === 0) {
        alert("هیچ کاڵایەک هەڵنەبژێردراوە");
        return;
      }

      const grandTotal = items.reduce((sum, i) => sum + i.total, 0);
      lastSaleData = { customer, items, grandTotal };

      alert("فرۆشتن بە سەرکەوتوویی تۆمار کرا! دەتوانیت PDF دابەزێنیت.");
      document.getElementById("downloadPdfBtn").style.display = "inline-block";
    };

    document.getElementById("downloadPdfBtn").onclick = () => {
      if (!lastSaleData) {
        alert("هیچ فرۆشتنێک نییە بۆ دابەزاندن");
        return;
      }
      generatePDF(lastSaleData);
    };

    function generatePDF(sale) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text(`فاکتەر بۆ: ${sale.customer}`, 10, 10);

      doc.setFontSize(12);
      let y = 20;
      sale.items.forEach((item, i) => {
        doc.text(
          `${i + 1}) ${item.productName} - بڕ: ${item.quantity}, نرخی یەکە: ${item.unitPrice}, داشکاندن: ${item.discountPercent}%, کۆی گشتی: ${item.total}`,
          10,
          y
        );
        y += 10;
      });

      doc.setFontSize(14);
      doc.text(`کۆی گشتی: ${sale.grandTotal} د.ع`, 10, y + 10);

      doc.save(`invoice_${sale.customer}.pdf`);
    }
  </script>

</body>
</html>
