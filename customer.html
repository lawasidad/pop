<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
    .dashboard { max-width: 1000px; margin: auto; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .btn { padding: 10px 16px; border: none; border-radius: 6px; color: white; background-color: #007bff; cursor: pointer; }
    .btn:hover { background-color: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #mapModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
    #mapContent { background: #fff; padding: 10px; border-radius: 8px; width: 90%; height: 80%; position: relative; }
    #map { width: 100%; height: 100%; border-radius: 8px; }
    .close-btn { position: absolute; top: 5px; right: 10px; font-size: 20px; cursor: pointer; color: #333; }
  </style>
</head>
<body>

<div class="dashboard">
  <div class="top-bar">
    <div><strong>Total Customers:</strong> <span id="totalCustomers">0</span></div>
    <div>
      <button class="btn" onclick="showAllOnMap()">Show All on Map</button>
    </div>
  </div>

  <table>
    <thead>
      <tr><th>Code</th><th>Name</th><th>Mobile</th><th>Location</th></tr>
    </thead>
    <tbody id="customerTable"></tbody>
  </table>
</div>

<!-- MAP MODAL -->
<div id="mapModal">
  <div id="mapContent">
    <span class="close-btn" onclick="closeMap()">&times;</span>
    <div id="map"></div>
  </div>
</div>

<script>
  function loadCustomerList() {
    const data = JSON.parse(localStorage.getItem("customers") || "[]");
    const tbody = document.getElementById("customerTable");
    tbody.innerHTML = "";
    document.getElementById("totalCustomers").textContent = data.length;
    data.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.code || ""}</td>
        <td>${c.name || ""}</td>
        <td>${c.mobile || ""}</td>
        <td>${c.location || "‚ùå"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function showAllOnMap() {
    const data = JSON.parse(localStorage.getItem("customers") || "[]");
    const mapContainer = document.getElementById("map");
    const modal = document.getElementById("mapModal");

    mapContainer.innerHTML = ""; // clear old map
    modal.style.display = "flex";

    const locations = data
      .filter(c => c.location && c.location.includes(","))
      .map(c => ({ ...c, coords: c.location.split(',').map(Number) }));

    if (locations.length === 0) return alert("No valid customer locations");

    const avgLat = locations.reduce((s, c) => s + c.coords[0], 0) / locations.length;
    const avgLng = locations.reduce((s, c) => s + c.coords[1], 0) / locations.length;

    const map = L.map("map").setView([avgLat, avgLng], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    locations.forEach(c => {
      const marker = L.marker(c.coords).addTo(map);
      marker.bindPopup(`<strong>${c.name}</strong><br>${c.mobile}`);
    });

    setTimeout(() => map.invalidateSize(), 200);
  }

  function closeMap() {
    document.getElementById("mapModal").style.display = "none";
  }

  loadCustomerList();
</script>

</body>
</html>
