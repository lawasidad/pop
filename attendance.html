<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Form</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      background: #f4f6f9;
      padding: 15px;
      max-width: 600px;
      margin: auto;
    }
    h2 {
      text-align: center;
      color: #14532d;
    }
    .form-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #14532d;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #0c2e17;
    }
    video, img {
      width: 100%;
      border-radius: 10px;
      margin: 10px 0;
    }
    .entry {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 14px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

  <h2>Attendance - In/Out</h2>

  <div class="form-section">
    <input type="text" id="name" placeholder="Your Full Name" />
    <button onclick="startCamera()">ðŸ“· Start Camera</button>
    <video id="video" autoplay playsinline muted style="display:none;"></video>
    <button onclick="takeSelfie()" style="display:none;" id="snapBtn">ðŸ“¸ Take Selfie</button>
    <img id="selfiePreview" style="display:none;" />
    <button onclick="markIn()">ðŸŸ¢ Mark In</button>
    <button onclick="markOut()">ðŸ”´ Mark Out</button>
  </div>

  <div id="entries"></div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const selfiePreview = document.getElementById('selfiePreview');
    let selfieData = "";

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
        video.srcObject = stream;
        video.style.display = "block";
        document.getElementById("snapBtn").style.display = "block";
        selfiePreview.style.display = "none";
      } catch (err) {
        alert("Camera error: " + err.message);
      }
    }

    function takeSelfie() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      selfieData = canvas.toDataURL("image/png");
      selfiePreview.src = selfieData;
      selfiePreview.style.display = "block";
      stopCamera();
    }

    function stopCamera() {
      const stream = video.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.style.display = "none";
      document.getElementById("snapBtn").style.display = "none";
    }

    function getTime() {
      return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function getDate() {
      return new Date().toISOString().split("T")[0];
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject("Geolocation not supported.");
        } else {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              resolve(`https://maps.google.com?q=${lat},${lon}`);
            },
            (err) => {
              const messages = {
                1: "Permission denied.",
                2: "Position unavailable.",
                3: "Timeout.",
              };
              reject(messages[err.code] || "Unknown error or quota exceeded.");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
          );
        }
      });
    }

    async function markIn() {
      const name = document.getElementById("name").value.trim();
      if (!name || !selfieData) {
        alert("Please enter your name and take a selfie.");
        return;
      }
      try {
        const location = await getLocation();
        const records = JSON.parse(localStorage.getItem("attendance") || "[]");
        records.push({
          name, date: getDate(), in: getTime(), out: "", selfieIn: selfieData,
          selfieOut: "", locationIn: location, locationOut: ""
        });
        localStorage.setItem("attendance", JSON.stringify(records));
        alert("Marked In");
        selfieData = "";
        loadEntries();
      } catch (err) {
        alert("Location error: " + err);
      }
    }

    async function markOut() {
      const name = document.getElementById("name").value.trim();
      if (!name || !selfieData) {
        alert("Please enter your name and take a selfie.");
        return;
      }
      try {
        const location = await getLocation();
        const records = JSON.parse(localStorage.getItem("attendance") || "[]");
        const lastIndex = records.map(r => r.name).lastIndexOf(name);
        if (lastIndex === -1 || records[lastIndex].out) {
          alert("No 'In' record found or already 'Out'.");
          return;
        }
        records[lastIndex].out = getTime();
        records[lastIndex].selfieOut = selfieData;
        records[lastIndex].locationOut = location;
        localStorage.setItem("attendance", JSON.stringify(records));
        alert("Marked Out");
        selfieData = "";
        loadEntries();
      } catch (err) {
        alert("Location error: " + err);
      }
    }

    function loadEntries() {
      const entries = JSON.parse(localStorage.getItem("attendance") || "[]").reverse();
      const container = document.getElementById("entries");
      container.innerHTML = "";
      entries.forEach(e => {
        container.innerHTML += `
          <div class="entry">
            <div><strong>Name:</strong> ${e.name}</div>
            <div><strong>Date:</strong> ${e.date}</div>
            <div><strong>In:</strong> ${e.in || "â€”"}</div>
            <div><strong>Out:</strong> ${e.out || "â€”"}</div>
            <div><strong>Location In:</strong> <a href="${e.locationIn}" target="_blank">View</a></div>
            ${e.locationOut ? `<div><strong>Location Out:</strong> <a href="${e.locationOut}" target="_blank">View</a></div>` : ""}
            <div><strong>Selfie In:</strong><br><img src="${e.selfieIn}" width="100" /></div>
            ${e.selfieOut ? `<div><strong>Selfie Out:</strong><br><img src="${e.selfieOut}" width="100" /></div>` : ""}
          </div>
        `;
      });
    }

    loadEntries();
  </script>

</body>
</html>
