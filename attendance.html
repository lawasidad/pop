<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Attendance with Camera Selfie Only</title>
<style>
  body {
    font-family: Tahoma, sans-serif;
    background: #f0f2f5;
    max-width: 700px;
    margin: 20px auto;
    padding: 15px;
  }
  h1 {
    text-align: center;
    color: #14532d;
    margin-bottom: 20px;
  }
  .section {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  label, input, button {
    width: 100%;
    display: block;
    margin-bottom: 12px;
    font-size: 16px;
  }
  input, button {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #aaa;
  }
  input:focus {
    border-color: #14532d;
    outline: none;
  }
  button {
    background-color: #14532d;
    color: white;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #0c2e17;
  }
  video, canvas, img.preview {
    width: 100%;
    max-height: 320px;
    border-radius: 14px;
    margin-bottom: 15px;
    object-fit: cover;
    background: #000;
  }
  .entry {
    background: #fafafa;
    border-radius: 10px;
    padding: 18px;
    margin-bottom: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    font-size: 14px;
    color: #222;
  }
  .entry div {
    margin-bottom: 8px;
  }
  .entry img {
    max-width: 140px;
    border-radius: 12px;
    object-fit: cover;
    margin-top: 6px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
  }
</style>
</head>
<body>

<h1>Attendance In/Out</h1>

<section class="section" aria-label="Attendance Form">
  <label for="name">Employee Name</label>
  <input type="text" id="name" placeholder="Enter your full name" required />

  <button type="button" id="startCameraBtn">ðŸŽ¥ Start Camera</button>
  <video id="video" autoplay playsinline muted style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="previewImg" class="preview" alt="Selfie Preview" style="display:none;" />

  <button id="takeSelfieBtn" style="display:none;">ðŸ“¸ Take Selfie</button>

  <button id="markInBtn">ðŸŸ¢ Mark In</button>
  <button id="markOutBtn">ðŸ”´ Mark Out</button>
</section>

<section id="entries" aria-live="polite" aria-atomic="true"></section>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const previewImg = document.getElementById("previewImg");
  const startCameraBtn = document.getElementById("startCameraBtn");
  const takeSelfieBtn = document.getElementById("takeSelfieBtn");
  const markInBtn = document.getElementById("markInBtn");
  const markOutBtn = document.getElementById("markOutBtn");

  let selfieData = "";

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      video.srcObject = stream;
      video.style.display = "block";
      takeSelfieBtn.style.display = "block";
      startCameraBtn.style.display = "none";
      previewImg.style.display = "none";
      selfieData = ""; // clear previous selfie
    } catch (err) {
      alert("Camera error: " + err.message);
    }
  }

  function stopCamera() {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    video.style.display = "none";
    takeSelfieBtn.style.display = "none";
    startCameraBtn.style.display = "block";
  }

  startCameraBtn.addEventListener("click", startCamera);

  takeSelfieBtn.addEventListener("click", () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.filter = "brightness(1.2) contrast(1.3) saturate(1.2)";
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    selfieData = canvas.toDataURL("image/png");
    previewImg.src = selfieData;
    previewImg.style.display = "block";
    alert("Selfie captured from camera!");
    stopCamera();
  });

  function getTime() {
    return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function getDate() {
    return new Date().toISOString().split("T")[0];
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject("Geolocation not supported");
      } else {
        navigator.geolocation.getCurrentPosition(
          pos => resolve(`https://maps.google.com?q=${pos.coords.latitude},${pos.coords.longitude}`),
          err => reject(err.message)
        );
      }
    });
  }

  async function markIn() {
    const name = document.getElementById("name").value.trim();
    if (!name) {
      alert("Please enter your name");
      return;
    }
    if (!selfieData) {
      alert("Please take a selfie before marking In.");
      return;
    }
    try {
      const location = await getLocation();
      const attendance = JSON.parse(localStorage.getItem("attendance") || "[]");
      attendance.push({
        name,
        date: getDate(),
        in: getTime(),
        out: "",
        selfieIn: selfieData,
        selfieOut: "",
        locationIn: location,
        locationOut: ""
      });
      localStorage.setItem("attendance", JSON.stringify(attendance));
      selfieData = "";
      previewImg.style.display = "none";
      alert("Marked In successfully!");
      loadEntries();
    } catch (err) {
      alert("Error getting location: " + err);
    }
  }

  async function markOut() {
    const name = document.getElementById("name").value.trim();
    if (!name) {
      alert("Please enter your name");
      return;
    }
    if (!selfieData) {
      alert("Please take a selfie before marking Out.");
      return;
    }
    try {
      const location = await getLocation();
      const attendance = JSON.parse(localStorage.getItem("attendance") || "[]");
      const lastIndex = attendance.map(e => e.name).lastIndexOf(name);
      if (lastIndex === -1 || attendance[lastIndex].out) {
        alert("No In record found or Out already marked for this name.");
        return;
      }
      attendance[lastIndex].out = getTime();
      attendance[lastIndex].selfieOut = selfieData;
      attendance[lastIndex].locationOut = location;
      localStorage.setItem("attendance", JSON.stringify(attendance));
      selfieData = "";
      previewImg.style.display = "none";
      alert("Marked Out successfully!");
      loadEntries();
    } catch (err) {
      alert("Error getting location: " + err);
    }
  }

  function loadEntries() {
    const entriesDiv = document.getElementById("entries");
    const attendance = JSON.parse(localStorage.getItem("attendance") || "[]");
    entriesDiv.innerHTML = "";
    attendance.slice().reverse().forEach(e => {
      entriesDiv.innerHTML += `
        <div class="entry" tabindex="0">
          <div><strong>Name:</strong> ${e.name}</div>
          <div><strong>Date:</strong> ${e.date}</div>
          <div><strong>In:</strong> ${e.in || "â€”"}</div>
          <div><strong>Out:</strong> ${e.out || "â€”"}</div>
          <div><strong>In Location:</strong> <a href="${e.locationIn}" target="_blank" rel="noopener noreferrer">View</a></div>
          ${e.locationOut ? `<div><strong>Out Location:</strong> <a href="${e.locationOut}" target="_blank" rel="noopener noreferrer">View</a></div>` : ""}
          <div><strong>Selfie In:</strong><br><img src="${e.selfieIn}" alt="Selfie In" /></div>
          ${e.selfieOut ? `<div><strong>Selfie Out:</strong><br><img src="${e.selfieOut}" alt="Selfie Out" /></div>` : ""}
        </div>
      `;
    });
  }

  markInBtn.onclick = markIn;
  markOutBtn.onclick = markOut;

  loadEntries();
</script>

</body>
</html>
