<script>
  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude.toFixed(5);
        const lon = position.coords.longitude.toFixed(5);
        document.getElementById("location").value = lat + ", " + lon;
        window.open(`https://maps.google.com/?q=${lat},${lon}`, "_blank");
      }, function(error) {
        alert("Error fetching location: " + error.message);
      });
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }

  function loadRouteData() {
    const routeSelect = document.getElementById("route");
    const citySelect = document.getElementById("city");
    const areaSelect = document.getElementById("area");

    const routes = JSON.parse(localStorage.getItem("routes") || "[]");
    const countries = [...new Set(routes.map(r => r.country))];

    countries.forEach(c => {
      const option = document.createElement("option");
      option.value = c;
      option.textContent = c;
      routeSelect.appendChild(option);
    });

    routeSelect.addEventListener("change", () => {
      const selectedCountry = routeSelect.value;
      const cities = [...new Set(routes.filter(r => r.country === selectedCountry).map(r => r.city))];
      citySelect.innerHTML = `<option value="" selected disabled>Select city</option>`;
      areaSelect.innerHTML = `<option value="" selected disabled>Select area</option>`;
      cities.forEach(city => {
        const option = document.createElement("option");
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    });

    citySelect.addEventListener("change", () => {
      const selectedCountry = routeSelect.value;
      const selectedCity = citySelect.value;
      const areas = routes.filter(r => r.country === selectedCountry && r.city === selectedCity).map(r => r.area);
      areaSelect.innerHTML = `<option value="" selected disabled>Select area</option>`;
      areas.forEach(area => {
        const option = document.createElement("option");
        option.value = area;
        option.textContent = area;
        areaSelect.appendChild(option);
      });
    });
  }

  function saveCustomer() {
    const code = document.getElementById("code").value.trim();
    const name = document.getElementById("name").value.trim();
    const mobile = document.getElementById("mobile").value.trim();
    const balance = parseFloat(document.getElementById("balance").value.trim() || "0");
    const route = document.getElementById("route").value;
    const city = document.getElementById("city").value;
    const area = document.getElementById("area").value;
    const location = document.getElementById("location").value.trim();

    if (!code || !name || !mobile) {
      alert("Please fill in all required fields (marked with *).");
      return;
    }

    const mobilePattern = /^[0-9+\-\s]{7,15}$/;
    if (!mobilePattern.test(mobile)) {
      alert("Please enter a valid mobile number.");
      return;
    }

    let customers = [];
    const stored = localStorage.getItem("customers");
    if (stored) {
      try {
        customers = JSON.parse(stored);
      } catch {
        customers = [];
      }
    }

    // سڕینەوەی چاککردنی duplicate
    // هیچ دووبارەچوونێک چک ناکرێت

    const newCustomer = { code, name, mobile, balance, route, city, area, location };
    customers.push(newCustomer);
    localStorage.setItem("customers", JSON.stringify(customers));

    localStorage.setItem("lastCustomerAdded", name);

    alert("Customer saved successfully!");

    document.getElementById("code").value = "";
    document.getElementById("name").value = "";
    document.getElementById("mobile").value = "";
    document.getElementById("balance").value = 0;
    document.getElementById("route").value = "";
    document.getElementById("city").value = "";
    document.getElementById("area").value = "";
    document.getElementById("location").value = "";
    document.getElementById("code").focus();
  }

  loadRouteData();
</script>
